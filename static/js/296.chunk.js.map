{"version":3,"file":"static/js/296.chunk.js","sources":["webpack://client/./src/common/host/web/authClient.ts","webpack://client/./src/common/host/web/themeClient.ts","webpack://client/./src/common/host/web/webHost.ts"],"sourcesContent":["import { PublicClientApplication } from '@azure/msal-browser';\r\nimport { z } from 'zod';\r\n\r\nimport { ILogger } from '@tdp/common/telemetry';\r\nimport { IAuthClient, TokenResponse, UserContext } from '@tdp/common/auth';\r\n\r\nconst TeamsAdministratorWid = \"62e90394-69f5-4237-9190-012177145e10\";\r\nconst GlobalAdminWid = \"69091246-20e8-4a56-aa4d-066075b2a7a8\";\r\nconst MsftTenantId = \"72f988bf-86f1-41af-91ab-2d7cd011db47\";\r\n\r\n/**\r\n * Get a \"hint\" for the user's Microsoft id (their email address if we have it).\r\n * this can streamline the login process by skipping the email prompt.\r\n */\r\nexport type LoginHintProvider = () => PromiseLike<string|undefined>;\r\n\r\nexport const MsalAuthClientAdapterConfigSchema = z.object({\r\n  /**\r\n   * Scopes used for the user's default login. \r\n   * This should be the scopes for the TDP API service\r\n   */\r\n  // We need to convert the canonical string with comma separators into an array of strings \r\n  loginScopes: z.preprocess(v => typeof v === \"string\" ? v.split(',') : v, z.array(z.string()).min(1)),\r\n\r\n  /**\r\n   * Where AzureAd should redirect to after completion\r\n   */\r\n  redirectStartPage: z.string().url(),\r\n});\r\n\r\ntype MsalAuthClientAdapterConfig = z.infer<typeof MsalAuthClientAdapterConfigSchema>;\r\n\r\nexport type MsalAuthClientAdapterDeps = {\r\n    logger: ILogger\r\n    application: PublicClientApplication\r\n    loginHintProvider: LoginHintProvider\r\n    config: MsalAuthClientAdapterConfig\r\n};\r\n\r\nexport class MsalAuthClientAdapter implements IAuthClient {\r\n  private logger: ILogger;\r\n  private loginHintProvider: LoginHintProvider;\r\n  private client: PublicClientApplication;\r\n  private config: MsalAuthClientAdapterConfig;\r\n\r\n  constructor({application, loginHintProvider, config, logger}: MsalAuthClientAdapterDeps) {\r\n    this.client = application;\r\n    this.loginHintProvider = loginHintProvider;\r\n    this.logger = logger;\r\n    this.config = config;\r\n  }\r\n\r\n  // TODO(nibeauli): this should probably have the ability to add additional scopes? Or is that not x-plat capable?\r\n  async login(silent?: boolean): Promise<UserContext> {\r\n    let ctx = this.readUserContext();\r\n    if (ctx.type != \"unauthenticated\") {\r\n      this.logger.trace(\"User already logged in\");\r\n      return ctx;\r\n    }\r\n    const {account} = (await this.client.handleRedirectPromise()) ?? {};\r\n    if (account) {\r\n      this.logger.trace('login complete');\r\n      this.client.setActiveAccount(account);\r\n    }\r\n    const loginHint = await this.loginHintProvider();\r\n\r\n    // attempt to read the context again after silent\r\n    ctx = this.readUserContext();\r\n    if (ctx.type !== \"unauthenticated\") {\r\n      this.logger.trace(\"User logged in via silent login\");\r\n      return ctx;\r\n    }\r\n\r\n    // if we aren't planning on interactively logging in the user and we' here, just return unauthenticated\r\n    if (silent) {\r\n      this.logger.warn(\"Silent login requested and user is currently unauthenticated\");\r\n      return ctx;\r\n    }\r\n\r\n    await this.client.acquireTokenRedirect({\r\n      scopes: this.config.loginScopes,\r\n      loginHint: loginHint,\r\n      redirectStartPage: this.config.redirectStartPage\r\n    });\r\n        \r\n    throw new Error('Impossible to reach statement');\r\n  }\r\n\r\n  private readUserContext(): UserContext {\r\n    const account = this.client.getActiveAccount();\r\n    if (!account) {\r\n      return { type: 'unauthenticated' };\r\n    }\r\n    const idTokenClaims = account.idTokenClaims;\r\n    if (!idTokenClaims) {\r\n      this.logger.trace(\"No token claims on current user\");\r\n      return { type: 'unauthenticated'};\r\n    }\r\n    const name = account.name;\r\n    const aadId = idTokenClaims.oid;\r\n    const preferredUserName = idTokenClaims?.preferred_username;\r\n    const wids = (idTokenClaims?.wids ?? []) as string[]; // explict cast only because wids is extended part of the id token claims object\r\n\r\n    if (!name || !aadId || !preferredUserName) {\r\n      // Log we're missing required fields\r\n      // only log boolean values, no the actual values\r\n      this.logger.trace(\"Missing claims for current user %o\", {aadId: !!aadId, preferred_username: !!preferredUserName, name: !!name});\r\n      return { type: 'unauthenticated'};\r\n    }\r\n    const isInternal = account.tenantId === MsftTenantId;\r\n\r\n    // we have an account, translate it into a user context object\r\n    return {\r\n      type: isInternal ? 'internal' : 'authenticated',\r\n      aadId: aadId,\r\n      isTenantAdmin: wids.some(s => s === GlobalAdminWid || s === TeamsAdministratorWid),\r\n      name: name,\r\n      userName: account.username,\r\n      preferredUserName,\r\n      tenantId: account.tenantId\r\n    };\r\n  }\r\n  \r\n  async getToken(scopes: string[]): Promise<TokenResponse> {\r\n    const authenticationResult = await this.client.acquireTokenSilent({\r\n      scopes: scopes\r\n    });\r\n    //TODO(nibeauli): detect failure case and convert to unauthenticated result.\r\n    return {\r\n      type: 'success', \r\n      token: authenticationResult.accessToken\r\n    };\r\n  }\r\n}\r\n\r\nexport const MsalConfigSchema = z.object({\r\n    auth: z.object({\r\n        clientId: z.string(),\r\n        authority: z.optional(z.string()),\r\n        redirectUri: z.string()\r\n    }),\r\n    cache: z.optional(z.object({\r\n        //TODO(nibeauli)\r\n    })),\r\n});\r\n\r\nexport const AuthConfigSchema = z.object({\r\n    msal: MsalConfigSchema,\r\n    client: MsalAuthClientAdapterConfigSchema\r\n});\r\n\r\nexport type WebHostAuthDependencies =\r\n    Omit<ConstructorParameters<typeof MsalAuthClientAdapter>[0], 'application' | 'config'> & {\r\n        config: z.infer<typeof AuthConfigSchema>\r\n    };\r\n\r\nexport async function composeAuth(deps: WebHostAuthDependencies) {\r\n    const { PublicClientApplication } = await import('@azure/msal-browser');\r\n    const msal = new PublicClientApplication(deps.config.msal);\r\n    await msal.initialize();\r\n    // force cast it to interface type\r\n    const authClient = new MsalAuthClientAdapter({ ...deps, application: msal, config: deps.config.client });\r\n    return { msal, authClient };\r\n}\r\n","import { IThemeClientService } from \"@tdp/common/theme/ThemeClient\";\r\nimport { ILogger } from '@tdp/common/telemetry';\r\nimport { Themes } from \"@tdp/common/theme/slice\";\r\n\r\nexport interface IThemeClientServiceDeps {\r\n  logger: ILogger\r\n}\r\n\r\nexport const preferredThemeKey = \"preferred_theme\";\r\n\r\nexport class ThemeClientService implements IThemeClientService {\r\n  private logger: ILogger;\r\n  constructor({logger}: IThemeClientServiceDeps) {\r\n\r\n    this.logger = logger;\r\n  }\r\n\r\n  public getHostTheme = () =>\r\n     (localStorage.getItem(preferredThemeKey) as Themes) ?? this.setTheme(Themes.Default);\r\n\r\n  public updateTheme = (theme: Themes) => this.setTheme(theme);\r\n\r\n  private setTheme = (theme: Themes): Themes => {\r\n    this.logger.log(`Setting ${theme} theme`);\r\n    localStorage.setItem(preferredThemeKey, Themes.Default);\r\n    return theme;\r\n  };\r\n}\r\n\r\nexport function composeTheme(logger: ILogger) {\r\n  const themeClientService = new ThemeClientService({ logger });\r\n  return { themeClientService };\r\n}\r\n\r\n","import { ITdpClientHost } from '@tdp/common/host';\r\nimport { BuildConfig } from '@tdp';\r\n\r\nimport { AuthConfigSchema, composeAuth, WebHostAuthDependencies } from './authClient';\r\nimport { composeTheme } from './themeClient';\r\n\r\n\r\ntype WebHostDependencies = Omit<WebHostAuthDependencies, 'config'> & {\r\n    config: BuildConfig\r\n};\r\n\r\nexport async function createHost(deps: WebHostDependencies): Promise<ITdpClientHost> {\r\n    const { config, ...authDeps } = deps;\r\n    const authConfig = AuthConfigSchema.parse(config['auth']);\r\n    const { authClient } = await composeAuth({\r\n        config: authConfig,\r\n        ...authDeps,\r\n    });\r\n    const { themeClientService } = await composeTheme(\r\n        authDeps.logger\r\n    );\r\n    return {\r\n        auth: authClient,\r\n        themeService: themeClientService\r\n    };\r\n}\r\n"],"names":["MsalAuthClientAdapterConfigSchema","z","loginScopes","v","split","min","redirectStartPage","url","MsalAuthClientAdapter","param","application","loginHintProvider","config","logger","client","login","silent","ctx","_ref","account","loginHint","readUserContext","type","trace","handleRedirectPromise","setActiveAccount","warn","acquireTokenRedirect","scopes","Error","_idTokenClaims_wids","getActiveAccount","idTokenClaims","name","aadId","oid","preferredUserName","preferred_username","wids","isInternal","tenantId","isTenantAdmin","some","s","userName","username","getToken","acquireTokenSilent","token","authenticationResult","accessToken","MsalConfigSchema","auth","clientId","authority","redirectUri","cache","AuthConfigSchema","msal","_composeAuth","deps","authClient","PublicClientApplication","initialize","preferredThemeKey","ThemeClientService","_localStorage_getItem","getItem","setTheme","Themes","theme","log","concat","localStorage","setItem","composeTheme","themeClientService","_createHost","authDeps","authConfig","composeAuth","themeService"],"mappings":"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"}